<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—ç‰¹è¨“ç­ (å¤šé¡Œåº«ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden-force { display: none !important; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 800px; min-height: 600px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        .nav-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; background: #f3f4f6; color: #4b5563; }
        .nav-btn:hover { background-color: #e5e7eb; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .shake { animation: shake 0.3s ease-in-out; border-color: #ef4444 !important; color: #ef4444 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        select { border: 1px solid #d1d5db; padding: 6px; border-radius: 4px; font-size: 14px; color: #374151; outline: none; background: white; max-width: 150px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: white; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1 style="margin: 0; font-size: 20px; color: #374151;">ğŸ”€ å–®å­—ç‰¹è¨“ç­</h1>
                
                <!-- é¡Œåº«é¸æ“‡å™¨ -->
                <select id="source-select" onchange="handleSourceChange()">
                    <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
                </select>
                <span id="status-msg" style="font-size: 12px; color: #6b7280;"></span>
            </div>

            <div style="display: flex; gap: 8px;">
                <button id="btn-manage" class="nav-btn active" onclick="switchTab('manage')">ç®¡ç†</button>
                <button id="btn-quiz" class="nav-btn" onclick="switchTab('quiz')">æ¸¬é©—</button>
            </div>
        </div>

        <!-- åˆ†é  1: ç®¡ç† -->
        <div id="view-manage" style="padding: 24px; flex: 1; display: flex; flex-direction: column;">
            
            <!-- æ–°å¢å€ -->
            <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dbeafe;">
                <h3 style="margin-top: 0; margin-bottom: 12px; color: #1e40af; font-size: 16px;">â• æ–°å¢ (å­˜æ–¼æœ¬åœ°ç€è¦½å™¨)</h3>
                <form id="add-form" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <input id="input-spelling" placeholder="è‹±æ–‡ (Apple)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <input id="input-meaning" placeholder="ä¸­æ–‡ (è˜‹æœ)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <input id="input-pos" placeholder="è©æ€§ (n.)" required style="flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <button type="submit" style="flex: 1; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 8px;">æ–°å¢</button>
                </form>
            </div>

            <!-- åˆ—è¡¨çµ±è¨ˆ -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #6b7280; font-size: 14px;">
                    ç›®å‰é¡¯ç¤ºï¼š<span id="current-source-name" style="font-weight: bold; color: #2563eb;">--</span> 
                    (<span id="cnt-total" style="font-weight: bold;">0</span> å­—)
                </span>
                <button onclick="resetLocalData()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 12px; text-decoration: underline;">æ¸…ç©ºæœ¬åœ°è³‡æ–™</button>
            </div>

            <!-- åˆ—è¡¨ -->
            <div style="flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; position: relative;">
                <div style="overflow-y: auto; height: 100%; max-height: 400px;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead style="background: #f9fafb; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">è‹±æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">ä¸­æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">è©æ€§</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right;">ä¾†æº</th>
                            </tr>
                        </thead>
                        <tbody id="word-list-body"></tbody>
                    </table>
                    <div id="list-empty-msg" style="display: none; text-align: center; padding: 40px; color: #9ca3af;">æ­¤é¡Œåº«æš«ç„¡å–®å­—</div>
                </div>
            </div>
        </div>

        <!-- åˆ†é  2: æ¸¬é©— -->
        <div id="view-quiz" class="hidden-force" style="padding: 24px; flex: 1; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <div style="width: 100%; height: 4px; background: #e5e7eb; margin-bottom: 8px; border-radius: 2px;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 40px;">
                æœ¬è¼ªå‰©é¤˜ï¼š<span id="queue-count">0</span> é¡Œ
            </div>

            <div id="quiz-card" style="width: 100%; max-width: 400px; margin: 0 auto;">
                <div style="margin-bottom: 20px;">
                    <span id="quiz-pos" style="background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 12px;">è©æ€§</span>
                    <h2 id="quiz-meaning" style="font-size: 32px; margin: 16px 0; color: #1f2937;">(é¡Œç›®)</h2>
                </div>

                <div style="position: relative; margin-bottom: 20px;">
                    <input id="quiz-input" type="text" placeholder="è¼¸å…¥æ‹¼å­—..." autocomplete="off"
                           style="width: 100%; text-align: center; font-size: 24px; border: none; border-bottom: 2px solid #d1d5db; padding: 10px; outline: none; background: transparent;">
                    <div id="quiz-msg" style="height: 20px; margin-top: 8px; font-size: 14px; font-weight: bold;"></div>
                </div>

                <button id="btn-next" class="hidden-force" onclick="nextQuestion()" style="width: 100%; background: #22c55e; color: white; font-size: 18px; font-weight: bold; padding: 12px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ä¸‹ä¸€é¡Œ â”
                </button>
            </div>

            <div id="quiz-empty-msg" class="hidden-force">
                <p style="font-size: 18px; color: #6b7280;">é¡Œåº«æ˜¯ç©ºçš„ï¼</p>
                <button onclick="switchTab('manage')" style="color: #2563eb; text-decoration: underline; background: none; border: none; cursor: pointer;">å›ç®¡ç†é åˆ‡æ›é¡Œåº«</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG_FILE = 'config.json'; 
        const STORAGE_KEY = 'vocab_app_multi_v1';

        // ç‹€æ…‹è®Šæ•¸
        let configSources = []; // å„²å­˜ config.json çš„å…§å®¹
        let localWords = [];    // æœ¬åœ° localStorage çš„å­—
        let remoteWords = [];   // ç•¶å‰é¸ä¸­é¡Œåº«çš„å­—
        let displayWords = [];  // åˆ—è¡¨é¡¯ç¤ºç”¨çš„å­— (local + remote)
        let quizQueue = [];
        let currentWord = null;

        window.onload = async function() {
            // åˆå§‹åŒ– UI
            document.getElementById('add-form').onsubmit = handleAddWord;
            document.getElementById('quiz-input').oninput = checkAnswer;
            document.getElementById('quiz-input').onkeydown = (e) => {
                if (e.key === 'Enter' && !document.getElementById('btn-next').classList.contains('hidden-force')) {
                    nextQuestion();
                }
            };

            loadLocalData();
            await loadConfig(); // 1. å…ˆè®€å–è¨­å®šæª”
        };

        // --- æ ¸å¿ƒ 1: è®€å–è¨­å®šèˆ‡å‹•æ…‹è¼‰å…¥ ---
        async function loadConfig() {
            const select = document.getElementById('source-select');
            select.innerHTML = '<option value="" disabled>è¼‰å…¥ä¸­...</option>';
            
            try {
                const res = await fetch(CONFIG_FILE);
                if (!res.ok) throw new Error('ç„¡æ³•è®€å–è¨­å®šæª”');
                configSources = await res.json();
                
                // å»ºç«‹ä¸‹æ‹‰é¸å–®
                select.innerHTML = '';
                
                // é¸é … 1: å…¨éƒ¨è¼‰å…¥
                const allOpt = document.createElement('option');
                allOpt.value = 'ALL';
                allOpt.text = 'ğŸ“š å…¨éƒ¨é¡Œåº«';
                select.appendChild(allOpt);

                // é¸é … 2...N: å„å€‹é¡Œåº«
                configSources.forEach(src => {
                    const opt = document.createElement('option');
                    opt.value = src.id; // é€™è£¡æ˜¯æª”å, e.g. "toeic.json"
                    opt.text = src.name;
                    select.appendChild(opt);
                });

                // é è¨­é¸ç¬¬ä¸€å€‹ (å…¨éƒ¨) æˆ–ä¸Šæ¬¡çš„é¸æ“‡
                handleSourceChange(); // è§¸ç™¼è¼‰å…¥

            } catch (err) {
                console.error(err);
                select.innerHTML = '<option disabled>è®€å–å¤±æ•—</option>';
            }
        }

        async function handleSourceChange() {
            const select = document.getElementById('source-select');
            const selectedValue = select.value;
            const status = document.getElementById('status-msg');
            
            status.innerText = 'è¼‰å…¥é¡Œåº«ä¸­...';
            remoteWords = []; // æ¸…ç©ºèˆŠçš„

            try {
                if (selectedValue === 'ALL') {
                    // ä½µç™¼è¼‰å…¥æ‰€æœ‰æª”æ¡ˆ
                    const promises = configSources.map(src => 
                        fetch(src.id).then(r => r.ok ? r.json() : []).catch(() => [])
                    );
                    const results = await Promise.all(promises);
                    
                    results.forEach((data, index) => {
                        if(Array.isArray(data)) {
                            const sourceName = configSources[index].name;
                            remoteWords = remoteWords.concat(processWords(data, sourceName));
                        }
                    });
                    document.getElementById('current-source-name').innerText = 'å…¨éƒ¨åˆä½µ';
                } else {
                    // å–®ä¸€è¼‰å…¥
                    const res = await fetch(selectedValue);
                    if (res.ok) {
                        const data = await res.json();
                        const sourceObj = configSources.find(s => s.id === selectedValue);
                        const name = sourceObj ? sourceObj.name : 'å¤–éƒ¨';
                        remoteWords = processWords(data, name);
                        document.getElementById('current-source-name').innerText = name;
                    }
                }
            } catch (e) {
                console.error("è¼‰å…¥é¡Œåº«å¤±æ•—", e);
            }

            status.innerText = '';
            updateDisplay();
            
            // å¦‚æœç›®å‰åœ¨æ¸¬é©—é é¢ï¼Œä¸”é¡Œåº«æ›äº†ï¼Œå¼·åˆ¶é‡ç½®æ¸¬é©—
            if (!document.getElementById('view-quiz').classList.contains('hidden-force')) {
                quizQueue = [];
                currentWord = null;
                initQuiz();
            }
        }

        function processWords(data, sourceLabel) {
            if (!Array.isArray(data)) return [];
            return data.map(w => ({
                id: 'remote_' + Math.random().toString(36).substr(2),
                s: w.spelling,
                m: w.meaning,
                p: w.pos,
                isRemote: true,
                source: sourceLabel
            }));
        }

        // --- æ ¸å¿ƒ 2: UI èˆ‡ æœ¬åœ°è³‡æ–™ ---
        function loadLocalData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) localWords = JSON.parse(raw);
            } catch (e) { localWords = []; }
        }

        function updateDisplay() {
            // åˆ—è¡¨é¡¯ç¤º = æœ¬åœ° + é ç«¯
            displayWords = [...localWords, ...remoteWords];
            renderList();
        }

        function renderList() {
            const tbody = document.getElementById('word-list-body');
            tbody.innerHTML = '';
            document.getElementById('cnt-total').innerText = displayWords.length;

            if (displayWords.length === 0) {
                document.getElementById('list-empty-msg').style.display = 'block';
                return;
            }
            document.getElementById('list-empty-msg').style.display = 'none';

            // æ¸²æŸ“å‰ 150 ç­†é¿å…å¡é “
            displayWords.slice(0, 150).forEach(w => {
                const tr = document.createElement('tr');
                
                // ä¾†æºæ¨™ç±¤
                let badgeText = w.isRemote ? (w.source || 'å¤–éƒ¨') : 'æœ¬åœ°è‡ªå»º';
                let badgeColor = w.isRemote ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                
                const action = w.isRemote
                    ? `<span style="color:#ccc">ğŸ”’</span>`
                    : `<button onclick="deleteLocalWord(${w.id})" style="color:#ef4444; background:none; border:none; cursor:pointer;">âœ•</button>`;

                tr.innerHTML = `
                    <td style="padding:12px; color:#2563eb; font-family:monospace;">${w.s}</td>
                    <td style="padding:12px;">${w.m}</td>
                    <td style="padding:12px;"><span style="background:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:12px;">${w.p}</span></td>
                    <td style="padding:12px; text-align:right; font-size:12px;">
                        <span class="${badgeColor} px-2 py-1 rounded mr-2">${badgeText}</span>
                        ${action}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- æ ¸å¿ƒ 3: æ–°å¢/åˆªé™¤/æ¸¬é©— (èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
        function handleAddWord(e) {
            e.preventDefault();
            const s = document.getElementById('input-spelling').value.trim();
            const m = document.getElementById('input-meaning').value.trim();
            const p = document.getElementById('input-pos').value.trim();
            if (!s || !m) return;

            localWords.unshift({ id: Date.now(), s, m, p, isRemote: false });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            e.target.reset();
            document.getElementById('input-spelling').focus();
            updateDisplay();
        }

        function deleteLocalWord(id) {
            localWords = localWords.filter(w => w.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            updateDisplay();
        }

        function resetLocalData() {
            if(!confirm('æ¸…ç©ºæœ¬åœ°è³‡æ–™ï¼Ÿ(å¤–éƒ¨é¡Œåº«ä¸æœƒå—å½±éŸ¿)')) return;
            localWords = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            updateDisplay();
        }

        function switchTab(tab) {
            const viewManage = document.getElementById('view-manage');
            const viewQuiz = document.getElementById('view-quiz');
            const btnManage = document.getElementById('btn-manage');
            const btnQuiz = document.getElementById('btn-quiz');

            if (tab === 'manage') {
                viewManage.classList.remove('hidden-force');
                viewManage.style.display = 'flex';
                viewQuiz.classList.add('hidden-force');
                btnManage.classList.add('active');
                btnQuiz.classList.remove('active');
            } else {
                viewManage.classList.add('hidden-force');
                viewQuiz.classList.remove('hidden-force');
                viewQuiz.style.display = 'flex';
                btnManage.classList.remove('active');
                btnQuiz.classList.add('active');
                initQuiz();
            }
        }

        function initQuiz() {
            if (displayWords.length === 0) {
                document.getElementById('quiz-card').classList.add('hidden-force');
                document.getElementById('quiz-empty-msg').classList.remove('hidden-force');
                return;
            }
            document.getElementById('quiz-empty-msg').classList.add('hidden-force');
            document.getElementById('quiz-card').classList.remove('hidden-force');
            
            if (!currentWord || !document.getElementById('btn-next').classList.contains('hidden-force')) {
                 if(!currentWord) nextQuestion();
            }
        }

        function nextQuestion() {
            if (displayWords.length === 0) return;

            if (quizQueue.length === 0) {
                // æ··åˆæ´—ç‰Œ (æœ¬åœ°+ç›®å‰é¸ä¸­çš„é ç«¯)
                let temp = [...displayWords];
                for (let i = temp.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [temp[i], temp[j]] = [temp[j], temp[i]];
                }
                quizQueue = temp;
            }

            currentWord = quizQueue.pop();
            updateProgress();

            // UI Reset
            const input = document.getElementById('quiz-input');
            input.value = '';
            input.disabled = false;
            input.style.color = 'black';
            input.style.borderBottomColor = '#d1d5db';
            document.getElementById('quiz-msg').innerText = '';
            document.getElementById('btn-next').classList.add('hidden-force');
            
            document.getElementById('quiz-meaning').innerText = currentWord.m;
            document.getElementById('quiz-pos').innerText = currentWord.p;
            setTimeout(() => input.focus(), 50);
        }

        function checkAnswer(e) {
            if (!currentWord) return;
            const val = e.target.value;
            const target = currentWord.s;
            const msg = document.getElementById('quiz-msg');

            if (val === target) {
                e.target.disabled = true;
                e.target.style.color = '#16a34a';
                e.target.style.borderBottomColor = '#16a34a';
                msg.innerText = 'ğŸ‰ Correct!';
                msg.style.color = '#16a34a';
                document.getElementById('btn-next').classList.remove('hidden-force');
                document.getElementById('btn-next').focus();
                return;
            }

            if (!target.startsWith(val)) {
                e.target.classList.add('shake');
                msg.innerText = 'âŒ æ‹¼å­—éŒ¯èª¤';
                msg.style.color = '#ef4444';
                setTimeout(() => e.target.classList.remove('shake'), 300);
            } else {
                e.target.classList.remove('shake');
                e.target.style.borderBottomColor = '#d1d5db';
                e.target.style.color = 'black';
                msg.innerText = '';
            }
        }

        function updateProgress() {
            const total = displayWords.length || 1;
            const remain = quizQueue.length;
            const percent = ((total - remain) / total) * 100;
            document.getElementById('queue-count').innerText = remain;
            document.getElementById('progress-bar').style.width = percent + '%';
        }
    </script>
</body>
</html>
